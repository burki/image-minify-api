imports:
    - { resource: 'parameters.yml' }

parameters:
  db:
    url: mysql://%db_config.user%:%db_config.password%@%db_config.host%/%db_config.database%
  configPath: %basePath%/config
  logPath: %basePath%/log

services:
  minify:
    class: IngoWalther\ImageMinifyApi\Minify\Minify
    arguments: [@fileHandler, @logger]
    calls:
      - [addCompressor, [@mozJpegCompressor]]
      - [addCompressor, [@pngquantCompressor]]
  mozJpegCompressor:
    class: IngoWalther\ImageMinifyApi\Compressor\MozJpegCompressor
  pngquantCompressor:
    class: IngoWalther\ImageMinifyApi\Compressor\PngquantCompressor
  fileHandler:
    class: IngoWalther\ImageMinifyApi\File\FileHandler
  randomStringGenerator:
    class: IngoWalther\ImageMinifyApi\Security\RandomStringGenerator
  apiKeyCheck:
    class: IngoWalther\ImageMinifyApi\Security\ApiKeyCheck
    arguments: [@userRepository]
  apiKeyGenerator:
    class: IngoWalther\ImageMinifyApi\Security\ApiKeyGenerator
    arguments: [@userRepository, @randomStringGenerator]
  userRepository:
    class: IngoWalther\ImageMinifyApi\Database\UserRepository
    arguments: [@dbConnection]
  dbConfig:
    class: Doctrine\DBAL\Configuration
  dbConnection:
    factory_class: Doctrine\DBAL\DriverManager
    factory_method: getConnection
    arguments: [%db%, @dbConfig]
  errorHandler:
    class: IngoWalther\ImageMinifyApi\Error\ErrorHandler
    arguments: [@logger]

  logger:
    class: Monolog\Logger
    arguments: ['ImageMinifyApi']
    calls:
      - [pushHandler, [@logHandler]]

  logHandler:
    class: Monolog\Handler\StreamHandler
    arguments: [%logPath%/app.log]

  console:
    class: Symfony\Component\Console\Application
    calls:
      - [add, [@addUserCommand]]
      - [add, [@listUserCommand]]
      - [add, [@setupCommand]]
  addUserCommand:
    class: IngoWalther\ImageMinifyApi\Command\AddUserCommand
    calls:
      - [setApiKeyGenerator, [@apiKeyGenerator]]
  listUserCommand:
    class: IngoWalther\ImageMinifyApi\Command\ListUserCommand
    calls:
      - [setUserRepository, [@userRepository]]
  setupCommand:
    class: IngoWalther\ImageMinifyApi\Command\SetupCommand
    calls:
      - [setConnection, [@dbConnection]]
      - [setConfigPath, [%configPath%]]
